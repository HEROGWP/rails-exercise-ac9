<h2>Todo SPA v3</h2>

<div id="todo-app">
  <input type="text" v-model="new_todo_title">
  <button v-on:click="add">Submit</button>

  <ul v-for="todo in todos">
    <li>
        {{ todo.title }}
        <a v-on:click="remove(todo)">(remove)</a>
    </li>
  </ul>
</div>

<script>

var todo_app = new Vue({
  el: '#todo-app',
  ready: function(){
    var that = this;

    App.messages = App.cable.subscriptions.create("TodosChannel", {
      connected: function() {
        console.log("connected");
      },
      disconnected: function() {
        console.log("disconnected");
      },
      received: function(todos) {
        that.todos = todos;
        that.new_todo_title = "";
      }
    });
  },
  methods: {
    add: function(){
      console.log("abc")
      var that = this;
      $.ajax({
        url: "/todos",
        type: "POST",
        data: {
          todo: {
            title: that.new_todo_title
          }
        },
        dataType: "json"
      })
    },
    remove: function(todo){
      var that = this;
      $.ajax({
        url : "/todos/" + todo.id,
        type: "DELETE",
        dataType: "json"
      })
    }
  },
  data: {
    todos: <%= @todos.to_json.html_safe %>
  }
})

</script>
